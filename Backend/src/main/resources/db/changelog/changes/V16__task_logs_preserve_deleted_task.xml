<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="V16-1" author="projectspring">
        <comment>Add task_title column to task_logs for preserving title after task deletion</comment>
        <addColumn tableName="task_logs">
            <column name="task_title" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="V16-2" author="projectspring">
        <comment>Make task_id nullable in task_logs so logs survive task deletion</comment>
        <dropNotNullConstraint tableName="task_logs" columnName="task_id" columnDataType="BIGINT"/>
    </changeSet>

    <changeSet id="V16-3" author="projectspring">
        <comment>Backfill task_title from existing task references</comment>
        <sql>UPDATE task_logs SET task_title = (SELECT title FROM tasks WHERE tasks.id = task_logs.task_id) WHERE task_title IS NULL AND task_id IS NOT NULL</sql>
    </changeSet>

</databaseChangeLog>
